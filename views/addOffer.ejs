<%- include('include/adminBase.ejs') %>
<!-- /include footer -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
<!-- MDB -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.css" rel="stylesheet" />

<style>
  .errorP {
      color: red;
      font-size: small;
  }
</style>
<!-- CONTENT -->
<section id="content">

    <!-- MAIN -->
    <main>
        <div class="table-data">
            <div class="order">
                <div class="head">
                    <h3>Add Offer</h3>

                    <a href="/admin-Offers">
                        <button class="btn btn-rounded" style="background-color: #131921 ; color: white;">
                            <i class='bx bx-exit'></i>Go Back
                        </button>
                    </a>
                </div>
                <div class="container coupon-container">

                    <form action="/add-Offers" method="post" id="coupon-form">
                        <div class="form-group">
                            <label for="category-code">Category Name</label>
                            <input type="text" class="form-control" id="category-code" placeholder="Enter Coupon Code" name="category">
                            <small id="category-code-error" class="text-danger"></small>
                            <p class="errorP <%= !categoryCodeError ? 'd-none' : '' %>"><%= categoryCodeError %></p>
                            <p class="errorP <%= !categoryRegex ? 'd-none' : '' %>"><%= categoryRegex %></p>
                            <p class="errorP <%= !categoryMatch ? 'd-none' : '' %>"><%= categoryMatch %></p>
                           
                        </div>
                        <div class="form-group">
                            <label for="discount">Discount (%)</label>
                            <input type="number" class="form-control" id="discount" placeholder="Enter Discount Percentage" name="discount">
                            <small id="discount-error" class="text-danger"></small>
                            <p class="errorP <%= !discountError ? 'd-none' : '' %>"><%= discountError %></p>
                            <p class="errorP <%= !discountRegex ? 'd-none' : '' %>"><%= discountRegex %></p>
                        </div>
                        <div class="form-group">
                            <label for="valid-from">Valid From</label>
                            <input type="date" class="form-control" id="valid-from" name="validFrom">
                            <small id="valid-from-error" class="text-danger"></small>
                            <p class="errorP <%= !validationFrom ? 'd-none' : '' %>"><%= validationFrom %></p>
                        </div>
                        <div class="form-group">
                            <label for="valid-to">Valid To</label>
                            <input type="date" class="form-control" id="valid-to" name="validTo">
                            <small id="valid-to-error" class="text-danger"></small>
                            <p class="errorP <%= !validationTo ? 'd-none' : '' %>"><%= validationTo %></p>
                        </div>
                        <h1></h1>
                        <button type="submit" class="btn" style="background-color: #131921; color: white;">Add Offer</button>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <!-- MAIN -->
</section>
<!-- CONTENT -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
  
   
 
    
      document.getElementById('coupon-form').addEventListener('submit', async function (event) {
          // Perform validation checks
          if (!(await validateForm())) {
              // Prevent form submission if validation fails
              event.preventDefault();
          }
      });

      // Validate form inputs
      async function validateForm() {
          const categoryCode = document.getElementById('category-code').value.trim();
          const discount = document.getElementById('discount').value.trim();
          const validFrom = document.getElementById('valid-from').value;
          const validTo = document.getElementById('valid-to').value;

          let valid = true;

          if(!categoryCode){
            showAlert("Category name is required")
            valid = false;
          }

          // Validate category code (Alphabetic)
          const categoryCodeRegex = /^[a-zA-Z]+$/;
          if (!categoryCodeRegex.test(categoryCode)) {
              showAlert("Category code should be Alphabetic");
              valid = false;
          }

          // Validate discount (Numeric)
          const discountRegex = /^[0-9]+$/;
          if (!discountRegex.test(discount)) {
              showAlert("Discount should be a numeric value");
              valid = false;
          }

          // Validate valid from date
          if (!validFrom) {
              showAlert("Valid from date is required");
              valid = false;
          }

          // Validate valid to date
          if (!validTo) {
              showAlert("Valid to date is required");
              valid = false;
          }

          // Check category code against the database
          
              const categoryValid = await checkCategoryCode(categoryCode);
              if (categoryCode !== categoryValid) {
                  showAlert("Category code does not exist or is inactive");
                  valid = false;
              }
          

          return valid;
      }

      // Function to check category code with the server
      async function checkCategoryCode(categoryCode) {
          try {
              const response = await fetch('/add-Offers', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ categoryCode })
              });
             
          } catch (error) {
              console.error('Error checking category code:', error);
              showAlert('Error checking category code. Please try again.');
              return false;
          }
      }


      // Function to show SweetAlert2 alert
      function showAlert(message) {
          Swal.fire({
              icon: 'error',
              title: 'Validation Error',
              text: message,
          });
      }

     
  });
  
</script>


    </body>

    </html>